<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIM v2 — Судалгааны Нэгдмэл Үнэлгээ (PDF/DOCX + Secure AI)</title>
  <meta name="description" content="DOCX/PDF унших, эвристик оношилгоо, серверийн проксиор AI дүгнэлт (API түлхүүрийг ил гаргахгүй)." />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    :root{ --bg:#0f1115;--card:#171922;--ink:#e8ecf2;--muted:#a9b3c6;--acc:#5aa7ff;--ok:#3bd671;--warn:#ffba3c;--bad:#ff5964;--chip:#202535;--line:#2b3042;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{padding:28px 20px 10px;display:flex;gap:18px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--line)}
    header h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.3px}
    header .tag{background:var(--chip);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    main{max-width:1200px;margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .card h2{margin:0 0 10px;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:var(--muted)}
    input[type=text], input[type=url], textarea{width:100%;background:#0c0e14;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px 12px;outline:0}
    textarea{min-height:180px;resize:vertical}
    input[type=file]{display:block;width:100%;background:#0c0e14;color:var(--ink);border:1px dashed var(--line);border-radius:10px;padding:12px}
    .btn{background:var(--acc);border:0;color:#041423;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#2a2f3f;color:var(--ink);border:1px solid var(--line)} .btn.ghost{background:transparent;border:1px dashed var(--line);color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    .kpi .box{background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:10px}
    .kpi .t{font-size:12px;color:var(--muted)} .kpi .v{font-size:20px;font-weight:800;margin-top:6px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--line);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px;margin:4px 6px 0 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px} .list{display:flex;flex-wrap:wrap;margin-top:6px}
    .meter{height:10px;background:#0c0e14;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .meter>span{display:block;height:100%;background:linear-gradient(90deg,var(--bad),var(--warn),var(--ok));width:0%}
    .small{font-size:12px;color:var(--muted)} .hl{color:#c3d7ff} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .divider{height:1px;background:var(--line);margin:12px 0} footer{padding:30px 20px;color:var(--muted);text-align:center}
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <h1>SIM v2 — Судалгааны Нэгдмэл Үнэлгээ</h1>
  <span class="tag">PDF/DOCX унших</span>
  <span class="tag">Secure AI (Server Proxy)</span>
  <span class="tag">Эвристик + LLM</span>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>1) Файл эсвэл текстээ оруул</h2>
      <div class="two">
        <div>
          <label>Бүтээлийн гарчиг</label>
          <input id="title" type="text" placeholder="ж: Эртний шатрын үүсэл, шинэ тайлбар" />
        </div>
        <div>
          <label>DOI/URL (заавал биш)</label>
          <input id="doi" type="url" placeholder="ж: https://doi.org/..." />
        </div>
      </div>

      <div class="divider"></div>

      <label>DOCX/PDF файл оруулах (аль нэг)</label>
      <input id="file" type="file" accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
      <p class="small">PDF нь pdf.js, DOCX нь mammoth.js ашиглан текст болгон хөрвөж, доорх талбарт автоматаар орно.</p>

      <div class="divider"></div>

      <label>Бүтэн текст (эсвэл хураангуй)</label>
      <textarea id="content" placeholder="Файл уншсаны дараа текст энд автоматаар гарна. Эс бөгөөс гараар буулгаж болно."></textarea>

      <div class="divider"></div>

      <h2>2) AI тохиргоо (API-г ил гаргахгүй)</h2>
      <div class="two">
        <div>
          <label>Серверийн прокси URL (ж: https://yourdomain.com/api/chat)</label>
          <input id="proxyUrl" type="url" placeholder="https://yourdomain.com/api/chat" />
        </div>
        <div>
          <label>LLM загварын нэр (сонголттой)</label>
          <input id="model" type="text" value="gpt-4o-mini" />
        </div>
      </div>
      <p class="small">API түлхүүрийг <b>сервер талд</b> хадгал. Энэ клиент зөвхөн таны прокси руу хүсэлт илгээнэ. Ингэснээр түлхүүр ил гарахгүй.</p>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="analyzeBtn">Оношилж үнэлэх</button>
        <button class="btn secondary" id="demoBtn">Жишээ текст</button>
        <button class="btn ghost" id="resetBtn">Цэвэрлэх</button>
      </div>
    </section>

    <section class="card">
      <h2>AI оношилгоо — салбар/төрөл</h2>
      <div class="kpi">
        <div class="box"><div class="t">Салбар</div><div class="v" id="kDomain">—</div></div>
        <div class="box"><div class="t">Баримт бичгийн төрөл</div><div class="v" id="kType">—</div></div>
        <div class="box"><div class="t">Чеклистийн ангилал</div><div class="v" id="kChecklist">—</div></div>
        <div class="box"><div class="t">Илрүүлэлт</div><div class="v" id="kDetect">—</div></div>
      </div>

      <div class="divider"></div>

      <h2>Стандартын багц</h2>
      <div id="stdChips" class="list"></div>

      <div class="divider"></div>

      <h2>Жинлэлт (салбар-онцлог)</h2>
      <div class="two">
        <div><label>E — Эпистем</label><div class="meter"><span id="wE"></span></div></div>
        <div><label>M — Арга зүй</label><div class="meter"><span id="wM"></span></div></div>
        <div><label>I — Инновац</label><div class="meter"><span id="wI"></span></div></div>
        <div><label>S — Нийгэм/Ёс зүй</label><div class="meter"><span id="wS"></span></div></div>
        <div><label>O — Ил тод байдал</label><div class="meter"><span id="wO"></span></div></div>
      </div>
      <p class="small">Жинлэлт нь салбар/төрлөөс хамааран автоматаар өөрчлөгдөнө.</p>
    </section>
  </div>

  <section class="card" style="margin-top:18px">
    <h2>Үр дүн — Нэгдмэл оноо ба тайлан</h2>
    <div class="kpi">
      <div class="box"><div class="t">Compliance %</div><div class="v" id="kC">—</div></div>
      <div class="box"><div class="t">Quality %</div><div class="v" id="kQ">—</div></div>
      <div class="box"><div class="t">RQS</div><div class="v" id="kRQS">—</div></div>
      <div class="box"><div class="t">Түвшин</div><div class="v" id="kRank">—</div></div>
    </div>

    <div class="divider"></div>

    <div class="two">
      <div>
        <h3>E/M/I/S/O — Тэнхлэгийн оноо</h3>
        <div class="two">
          <div><label>E</label><div class="meter"><span id="sE"></span></div></div>
          <div><label>M</label><div class="meter"><span id="sM"></span></div></div>
          <div><label>I</label><div class="meter"><span id="sI"></span></div></div>
          <div><label>S</label><div class="meter"><span id="sS"></span></div></div>
          <div><label>O</label><div class="meter"><span id="sO"></span></div></div>
        </div>
        <p class="small">Текстээс эвристикаар оноо гарч, жинлэлтийн дагуу Quality% болно.</p>
      </div>
      <div>
        <h3>Best-Possible (SOTA) ≤→ Gap</h3>
        <ul class="rec" id="gapList"></ul>
        <p class="small">Дээд боломжит төлөв = CONSORT/PRISMA/STROBE/ARRIVE/CARE + FAIR + COPE + ICMJE + Nature reporting бүрэн биелэлт.</p>
      </div>
    </div>

    <div class="divider"></div>

    <h3>Автомат сайжруулах санал</h3>
    <ul class="rec" id="fixList"></ul>

    <div class="divider"></div>

    <h3>Дэлгэрэнгүй AI дүгнэлт (серверийн проксигоор)</h3>
    <p class="small">Прокси URL бөглөвөл доорх талбар дүүрнэ. API түлхүүрийг зөвхөн сервер талд хадгал.</p>
    <pre id="aiReport" class="mono small" style="white-space:pre-wrap;background:#0c0e14;border:1px solid var(--line);border-radius:10px;padding:12px;">—</pre>
  </section>

  <section class="card" style="margin-top:18px">
    <h2>Аюулгүй байдлын бодлого (товч)</h2>
    <ul class="small">
      <li>Клиент талд API түлхүүр хадгалахгүй/асуухгүй.</li>
      <li>LLM хүсэлт зөвхөн таны тохируулсан <span class="hl">серверийн прокси</span> руу явна.</li>
      <li>Файл унших нь браузертоо (локал) хийгдэнэ; сервер рүү автоматаар илгээхгүй.</li>
    </ul>
  </section>
</main>

<footer>© SIM v2 — DOCX/PDF + Secure AI Proxy</footer>

<script>
const el = id => document.getElementById(id);
const chips = (arr)=>arr.map(x=>`<span class="pill">${x}</span>`).join("");

/* File Readers */
async function readPDF(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
  let text = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const strings = content.items.map(it => it.str);
    text += strings.join(" ") + "\\n";
  }
  return text;
}
async function readDOCX(file){
  const arrayBuffer = await file.arrayBuffer();
  const res = await window.mammoth.extractRawText({arrayBuffer});
  return res.value || "";
}
el("file").addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  try{
    el("content").value = "Файлыг уншиж байна…";
    let txt="";
    if(f.type === "application/pdf" || f.name.toLowerCase().endsWith(".pdf")){
      txt = await readPDF(f);
    }else if(f.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || f.name.toLowerCase().endsWith(".docx")){
      txt = await readDOCX(f);
    }else{
      alert("Зөвхөн PDF эсвэл DOCX файлаар туршина уу.");
      el("content").value="";
      return;
    }
    el("content").value = txt.trim();
  }catch(err){
    console.error(err);
    alert("Файл уншихад алдаа гарлаа.");
    el("content").value="";
  }
});

/* Detection */
function detectDomainAndType(text){
  const t = text.toLowerCase();
  const hits = (kws)=>kws.some(k=>t.includes(k));

  let domain = "Ерөнхий";
  if(hits(["randomized","consort","clinical trial","p value","p=", "95% ci","blinded"])) domain = "Анагаах (RCT)";
  else if(hits(["systematic review","meta-analysis","prisma"])) domain = "Анагаах (Системчилсэн тойм)";
  else if(hits(["cohort","case-control","strobe","observational"])) domain = "Анагаах (Ажиглалтын)";
  else if(hits(["animal","mouse","rat","arrive guidelines"])) domain = "Амьтны туршилт";
  else if(hits(["case report","care guidelines"])) domain = "Кейс репорт";
  else if(hits(["loss function","neural network","dataset","benchmark","baseline","auc","roc","precision","recall","f1","learning rate","epochs","github"])) domain = "Компьютер/ML";
  else if(hits(["lagrangian","hamiltonian","gauge","renormalization","hilbert space","lemma","theorem"])) domain = "Математик/Теор физик";
  else if(hits(["manuscript","monograph","chapter","archive","inscription","philology","hermeneutics","exegesis","ethnography"])) domain = "Хүмүүнлэг/Ном судлал";
  else if(hits(["finite element","simulation","prototype","sensor","circuit","mechanical","materials"])) domain = "Инженер/Техник";
  else if(hits(["regression","survey","questionnaire","anova","structural equation","sem","panel data"])) domain = "Нийгмийн шинжлэх ухаан";

  let type="Ерөнхий судалгаа", checklist="Ерөнхий (Nature reporting/MDAR/FAIR/COPE/ICMJE)";
  if(domain.includes("RCT")){ type="Санамсаргүй хяналттай туршилт"; checklist="CONSORT + ICMJE + COPE + FAIR"; }
  else if(domain.includes("Системчилсэн")){ type="Системчилсэн тойм/мета"; checklist="PRISMA + ICMJE + COPE + FAIR"; }
  else if(domain.includes("Ажиглалтын")){ type="Ажиглалтын судалгаа"; checklist="STROBE + ICMJE + COPE + FAIR"; }
  else if(domain.includes("Амьтны")){ type="Амьтны туршилт"; checklist="ARRIVE + ICMJE + COPE + FAIR"; }
  else if(domain.includes("Кейс репорт")){ type="Кейс репорт"; checklist="CARE + ICMJE + COPE + FAIR"; }
  else if(domain.includes("Компьютер/ML")){ type="ML/AI судалгаа"; checklist="ML Repro + Nature reporting + FAIR + COPE"; }
  else if(domain.includes("Математик/Теор")){ type="Онолын өгүүлэл"; checklist="Nature reporting + ICMJE + COPE"; }
  else if(domain.includes("Хүмүүнлэг")){ type="Монограф/Хүмүүнлэгийн өгүүлэл"; checklist="ICMJE + FAIR + COPE"; }
  else if(domain.includes("Инженер")){ type="Инженерийн судалгаа"; checklist="Nature reporting + FAIR + COPE"; }
  else if(domain.includes("Нийгмийн")){ type="Нийгмийн судалгаа"; checklist="STROBE(хамаарах бол) + Nature reporting + FAIR + COPE"; }

  let detect = [];
  if(/doi\\.org\\/|doi:\\s*\\d+\\.\\d+/i.test(text)) detect.push("DOI илэрлээ");
  if(/github\\.com|gitlab\\.com|bitbucket\\.org/i.test(text)) detect.push("Кодын агуулах илэрлээ");
  if(/\\b(dataset|data repository|zenodo|figshare|dryad|kaggle)\\b/i.test(text)) detect.push("Өгөгдлийн репозитори дурдсан");
  if(/\\bpreregister|osf\\.io|trial registration|clinicaltrials\\.gov\\b/i.test(text)) detect.push("Урьдчилан бүртгэл/туршилтын бүртгэл");
  if(detect.length===0) detect=["Тусгай маркер илрээгүй"];

  return {domain,type,checklist,detect:detect.join(", ")};
}

/* Weights, compliance, axes, RQS */
const WEIGHTS = {
  "Анагаах (RCT)": {E:.15,M:.35,I:.10,S:.25,O:.15, std:["CONSORT","ICMJE","COPE","FAIR"]},
  "Анагаах (Системчилсэн тойм)": {E:.15,M:.30,I:.10,S:.25,O:.20, std:["PRISMA","ICMJE","COPE","FAIR"]},
  "Анагаах (Ажиглалтын)": {E:.18,M:.30,I:.12,S:.25,O:.15, std:["STROBE","ICMJE","COPE","FAIR"]},
  "Амьтны туршилт": {E:.15,M:.35,I:.10,S:.25,O:.15, std:["ARRIVE","ICMJE","COPE","FAIR"]},
  "Кейс репорт": {E:.18,M:.22,I:.10,S:.25,O:.25, std:["CARE","ICMJE","COPE","FAIR"]},
  "Компьютер/ML": {E:.15,M:.25,I:.25,S:.15,O:.20, std:["ML Repro","Nature reporting","FAIR","COPE"]},
  "Математик/Теор физик": {E:.35,M:.15,I:.25,S:.10,O:.15, std:["Nature reporting","ICMJE","COPE"]},
  "Хүмүүнлэг/Ном судлал": {E:.30,M:.15,I:.20,S:.15,O:.20, std:["ICMJE","FAIR","COPE"]},
  "Инженер/Техник": {E:.20,M:.30,I:.20,S:.15,O:.15, std:["Nature reporting","FAIR","COPE"]},
  "Нийгмийн шинжлэх ухаан": {E:.20,M:.25,I:.20,S:.20,O:.15, std:["STROBE(хамаарах бол)","Nature reporting","FAIR","COPE"]},
  "Ерөнхий": {E:.25,M:.25,I:.20,S:.15,O:.15, std:["Nature reporting","ICMJE","FAIR","COPE"]}
};
function complianceHeuristic(type, text){
  const t = text.toLowerCase(), has = kw => kw.some(k=>t.includes(k));
  let score=0, total=0, gaps=[];
  const add=(cond,name)=>{ total++; if(cond){score++;} else {gaps.push(name);} };

  add(has(["abstract","summary","хураангуй"]), "Хураангуй/абстракт");
  add(has(["introduction","оршил","background"]), "Оршил");
  add(has(["methods","арга зүй","materials and methods","протокол"]), "Арга зүй/Протокол");
  add(has(["results","үр дүн"]), "Үр дүн");
  add(has(["discussion","хэлэлцүүлэг","limitation","хязгаарлалт"]), "Хэлэлцүүлэг/Хязгаарлалт");
  add(has(["conclusion","дүгнэлт"]), "Дүгнэлт");
  add(has(["references","эшлэл","лавлагаа","bibliography"]), "Эшлэл/Лавлагаа");
  add(/doi\\.org\\/|doi:\\s*\\d+\\.\\d+/.test(text), "DOI/байнгын таних");
  add(/github\\.com|gitlab\\.com|bitbucket\\.org|code\\s*availability/i.test(text), "Кодын хүртээмж");
  add(/\\b(dataset|data availability|repository|zenodo|figshare|dryad|kaggle)\\b/i.test(text), "Өгөгдлийн хүртээмж");
  add(/\\blicense\\b|creativecommons|cc-by|mit license|apache-2/i.test(text), "Лицензийн тодорхойлолт");

  if(type.includes("Санамсаргүй")){
    add(has(["randomized","allocation","blinded","placebo"]), "CONSORT: санамсаргүйжүүлэлт/нуух");
    add(has(["trial registration","clinicaltrials.gov","registration"]), "CONSORT: Бүртгэл");
    add(has(["sample size","power calculation"]), "CONSORT: Хэмжээ тооцоо");
  }
  if(type.includes("Системчилсэн")){
    add(has(["prisma","flow diagram","search strategy","inclusion criteria","exclusion criteria"]), "PRISMA: хайлт/урсгал");
    add(has(["risk of bias","robins-i","cochrane"]), "PRISMA: Bias үнэлгээ");
  }
  if(type.includes("Ажиглалтын")){
    add(has(["cohort","case-control","cross-sectional","strobe"]), "STROBE: дизайн тодорхой");
    add(has(["confounder","adjusted","multivariable"]), "STROBE: Будлиан шүүсэн");
  }
  if(type.includes("Амьтны")){
    add(has(["arrive","animal care","ethical approval"]), "ARRIVE/Этик зөвшөөрөл");
  }
  if(type.includes("Кейс репорт")){
    add(has(["case report","patient","consent","care guidelines"]), "CARE: Өвчтөний зөвшөөрөл/төлөв");
  }
  if(type.includes("ML/AI")){
    add(has(["baseline","benchmark","train","test","split","seed"]), "ML Repro: сургалтын протокол");
    add(has(["hyperparameter","learning rate","batch size","epochs"]), "ML Repro: гиперпараметр");
    add(has(["github","reproduc","script","environment","requirements.txt","docker"]), "ML Repro: орчин/давтагдах");
  }
  return {pct: Math.round(100*score/Math.max(total,1)), gaps};
}
function axisScores(text){
  const t = text.toLowerCase(), has = kw=>kw.some(k=>t.includes(k));
  const E = Math.round(((has(["theorem","proof","lemma","hypothesis","framework","онол","парадигм"])?9:7) + (has(["related work","өмнөх судалгаа"])?8:6) + (has(["taxonomy","classification","conceptual","ортогональ"])?8:6) + (has(["interdisciplinary","cross-domain","огтлолцол","интердисциплин"])?8:5))/4);
  const M = Math.round(((has(["methods","materials and methods","protocol","algorithm","pipeline","протокол"])?9:6) + (has(["statistical","anova","regression","bayesian","confidence interval","p="])?8:5) + (has(["code availability","reproduc","seed","docker","environment"])?8:4) + (t.length>2000?8:5))/4);
  const I = Math.round(((has(["novel","шинэ арга","we propose","шинэлэг"])?9:6) + (has(["open-source","toolkit","prototype","simulator"])?8:5) + (has(["future work","дараагийн судалгаа","extension"])?8:5) + (has(["generalize","transfer","domain adaptation"])?7:5))/4);
  const S = Math.round(((has(["ethics","ethical approval","ирб","consent","respect","harm","risk"])?9:5) + (has(["societal impact","policy","conflict of interest","ашиг сонирхлын зөрчил"])?8:5) + (has(["limitation","bias","responsible","safety"])?8:6) + (has(["human-centered","хүн төвтэй"])?7:5))/4);
  const O = Math.round(((/doi\\.org\\/|doi:\\s*\\d+\\.\\d+/.test(text)?9:5) + (/\\b(dataset|data availability|repository|zenodo|figshare|dryad|kaggle)\\b/i.test(text)?8:4) + (/github\\.com|gitlab\\.com|bitbucket\\.org/i.test(text)?8:4) + (/\\blicense\\b|creativecommons|cc-by|mit license|apache-2/i.test(text)?7:4))/4);
  return {E,M,I,S,O};
}
function computeRQS(Cpct, axes, domain){
  const w = WEIGHTS[domain] || WEIGHTS["Ерөнхий"];
  const Qraw = axes.E*w.E + axes.M*w.M + axes.I*w.I + axes.S*w.S + axes.O*w.O;
  const Qpct = Math.round(100 * (Qraw/10));
  const RQS = Math.round(0.6*Cpct + 0.4*Qpct);
  let rank = "—";
  if(RQS>=90) rank="A+ (Парадигм)";
  else if(RQS>=80) rank="A (Өндөр түвшин)";
  else if(RQS>=70) rank="B (Хөгжлийн түвшин)";
  else if(RQS>=60) rank="C (Суралцах түвшин)";
  else if(RQS>=50) rank="D (Сорилтын түвшин)";
  else rank="E (Шинжлэх ухааны бус)";
  return {Qpct,RQS,rank,weights:w};
}
function buildGaps(domain, compGaps){
  const w = WEIGHTS[domain] || WEIGHTS["Ерөнхий"];
  const std = w.std || [];
  const list = [];
  if(compGaps.length){ compGaps.forEach(g=>list.push("Чеклист: " + g + " — нэмж тодорхой бич.")); }
  else{ list.push("Албан чеклистийн ихэнх заалтыг хангаж байна."); }
  if(!std.includes("FAIR")) list.push("FAIR багц: PID, мета өгөгдлийн схем, репозитори, лицензийг системтэй бич.");
  if(!std.includes("ICMJE")) list.push("ICMJE/Vancouver: эшлэлийн хэв загварыг нэг мөр болго.");
  if(!std.includes("COPE")) list.push("COPE: нийтлэлийн ёс зүйн зарчмуудыг ил тод мэдэгд.");
  if(!std.includes("Nature reporting")) list.push("Nature reporting/MDAR: материал/арга/өгөгдөл/шинжилгээний тоймыг хүснэгтээр хавсарга.");
  return list;
}
function buildFixes(domain,type,axes){
  const rec=[];
  if(axes.O<7) rec.push("Ил тод байдал: өгөгдөл/код, лиценз, DOI-г бүрэн болго.");
  if(axes.M<7) rec.push("Арга зүй: протокол, статистик загвар, мэдрэг чанарын шинжилгээг дэлгэрүүл.");
  if(axes.E<7) rec.push("Эпистем: онолын байрлалаа өмнөх судалгаатай илүү гүн холбож тайлбарла.");
  if(axes.I<7) rec.push("Инновац: шинэ арга, прототип, нээлттэй хэрэгслээр санааны үржлийг нэм.");
  if(axes.S<7) rec.push("Нийгэм/Ёс зүй: нөлөөлөл, эрсдэлийн үнэлгээ, ашиг сонирхлын зөрчлийг тодорхой бич.");
  if(type.includes("Системчилсэн")) rec.push("PRISMA хайлтын стратеги, flow-diagram, bias үнэлгээг хавсарга.");
  if(type.includes("Санамсаргүй")) rec.push("CONSORT: санамсаргүйжүүлэлт, нуух, хэмжээний тооцоог тодорхой болго.");
  if(type.includes("ML/AI")) rec.push("ML Repro: seed, орчин, гиперпараметр, контейнерийг давтагдахуйц болго.");
  return rec;
}

async function callProxy(proxyUrl, payload){
  try{
    const res = await fetch(proxyUrl,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error("Proxy error: "+res.status);
    const data = await res.json();
    return data.output || data.text || JSON.stringify(data);
  }catch(err){
    console.error(err);
    return "Прокси ажилласангүй. Прокси URL-ээ шалгаарай.";
  }
}

function setMeter(id, pct){ document.getElementById(id).style.width = Math.max(0,Math.min(100,pct))+"%"; }
function renderWeights(w){ setMeter("wE", w.E*100); setMeter("wM", w.M*100); setMeter("wI", w.I*100); setMeter("wS", w.S*100); setMeter("wO", w.O*100); }
function renderAxis(ax){ setMeter("sE", ax.E*10); setMeter("sM", ax.M*10); setMeter("sI", ax.I*10); setMeter("sS", ax.S*10); setMeter("sO", ax.O*10); }

async function runAnalysis(){
  const title = el("title").value.trim();
  const doi = el("doi").value.trim();
  const text = (title? (title+"\\n"): "") + (doi? (doi+"\\n"): "") + el("content").value.trim();
  if(text.length<200){ alert("Хамгийн багадаа ~200 тэмдэгт текст оруулна уу."); return; }

  const det = detectDomainAndType(text);
  el("kDomain").textContent = det.domain;
  el("kType").textContent = det.type;
  el("kChecklist").textContent = det.checklist;
  el("kDetect").textContent = det.detect;

  const weight = WEIGHTS[det.domain] || WEIGHTS["Ерөнхий"];
  el("stdChips").innerHTML = chips(weight.std); renderWeights(weight);

  const comp = complianceHeuristic(det.type, text);
  const axes = axisScores(text); renderAxis(axes);

  const score = computeRQS(comp.pct, axes, det.domain);
  el("kC").textContent = comp.pct + " %";
  el("kQ").textContent = score.Qpct + " %";
  el("kRQS").textContent = score.RQS;
  el("kRank").textContent = score.rank;

  const gaps = buildGaps(det.domain, comp.gaps);
  el("gapList").innerHTML = gaps.map(g=>`<li>${g}</li>`).join("");
  const fixes = buildFixes(det.domain, det.type, axes);
  el("fixList").innerHTML = fixes.map(g=>`<li>${g}</li>`).join("");

  const proxyUrl = el("proxyUrl").value.trim();
  if(proxyUrl){
    el("aiReport").textContent = "Проксигоор AI тайлан авч байна…";
    const prompt = `
Судалгааны бүтээлийг Монгол хэлээр дүгнэ. 
1) салбар/төрөл зөв эсэх, 2) чеклистийн сул цэг, 3) сайжруулах алхмууд, 
4) ёс зүй ба ил тод байдалд хийх нэмэлт. 
Оношилгоо: салбар=${det.domain}, төрөл=${det.type}, чеклист=${det.checklist}, 
Compliance=${comp.pct}%, E=${axes.E}, M=${axes.M}, I=${axes.I}, S=${axes.S}, O=${axes.O}, RQS=${score.RQS} (${score.rank}).
Текст:\n${text.slice(0,12000)}`;
    const out = await callProxy(proxyUrl, {model: el("model").value.trim(), prompt});
    el("aiReport").textContent = out;
  }else{
    el("aiReport").textContent = "Прокси URL оруулаагүй тул LLM тайлан идэвхгүй байна. Эвристик оношилгоо бүрэн хийгдсэн.";
  }
}

function loadDemo(){
  el("title").value = "Randomized Controlled Trial on Cognitive Training with Open Data & Code";
  el("doi").value = "https://doi.org/10.1234/demo.2025.001";
  el("content").value =
`Abstract: We propose a randomized, double-blinded clinical trial with trial registration at ClinicalTrials.gov.
Introduction: Prior work shows mixed results...
Methods: Randomized allocation, blinding, placebo control, power calculation (sample size), statistical analysis (ANOVA, CI).
Results: Significant improvement (p=0.02, 95% CI ...). Code availability: GitHub repo; Data availability: Zenodo. License: CC-BY.
Discussion: Limitation, risk of bias, harm-benefit considered. Societal impact and conflict of interest disclosed.
Conclusion.
References: Vancouver style.`;
}
function resetAll(){
  ["title","doi","content","proxyUrl"].forEach(id=>el(id).value="");
  ["kDomain","kType","kChecklist","kDetect","kC","kQ","kRQS","kRank"].forEach(id=>el(id).textContent="—");
  ["stdChips","gapList","fixList"].forEach(id=>el(id).innerHTML="");
  ["wE","wM","wS","wI","wO","sE","sM","sS","sI","sO"].forEach(id=>setMeter(id,0));
  el("aiReport").textContent="—";
}
document.getElementById("analyzeBtn").addEventListener("click", runAnalysis);
document.getElementById("demoBtn").addEventListener("click", loadDemo);
document.getElementById("resetBtn").addEventListener("click", resetAll);
</script>
</body>
</html>
